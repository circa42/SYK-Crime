{% set firstLinkBlock = entry.storeLinks|first %}
{% if firstLinkBlock %}
  {% set storeCategory = firstLinkBlock.stores[0] %}
  {% set firstUrl = firstLinkBlock.storeLink %}
  {% set aff = '?linkCode=ll1&tag=sykcrime-20&language=en_US&ref_=as_li_ss_tl'|raw %}
  {% if storeCategory and "amazon" in storeCategory.slug %}
    {% set firstUrl = firstUrl ~ aff  %}
  {% endif %}
{% endif %}

<div class="book-entry flex xs:flex-wrap sm:flex-nowrap mb-8 bg-white drop-shadow border p-4">
  <!-- Book Image -->
  <div class="book-image sm:mr-6 flex mx-auto mb-8 justify-center">
    <div class="text-center">
      {% if entry.bookCover|length %}
        {% if firstUrl is defined %}
          <a href="{{ firstUrl }}" target="_blank">
            <img src="{{ entry.bookCover[0].getUrl('thumb') }}" alt="{{ entry.title }} cover" loading="lazy">
          </a>
        {% else %}
          <img src="{{ entry.bookCover[0].getUrl('thumb') }}" alt="{{ entry.title }} cover" loading="lazy">
        {% endif %}
      {% endif %}
      {% if currentUser %}
        <div class="mt-4">
          <a href="{{ entry.cpEditUrl }}" class="text-xs uppercase" target="_blank">
            edit entry
          </a>
        </div>
      {% endif %}
    </div>
  </div>
  <!-- Book Details --> 
  {% set explicitTooltipId = 'tooltip-explicit-' ~ entry.id %}
  {% set shortReadTooltipId = 'tooltip-short-read-' ~ entry.id %}
  {% set hasExplicit = entry.explicit == 1 %}
  {% set hasShortRead = entry.shortRead == 1 %}
  {% set hasBadges = hasExplicit or hasShortRead %}
  {% set badges -%}
    {% if hasBadges %}
      <div class="flex flex-wrap items-center gap-2 w-full mt-2 md:mt-0 md:w-auto md:ml-1 xs:mb-2 md:mb-0">
        {% if hasExplicit %}
          <span class="relative inline-flex items-center justify-center uppercase text-xs text-white bg-red-500 px-2 py-0.5" data-tooltip-trigger tabindex="0" role="button" aria-label="Explicit content" aria-describedby="{{ explicitTooltipId }}" aria-expanded="false">
            <span aria-hidden="true">E</span>
            <span
              id="{{ explicitTooltipId }}"
              class="absolute hidden text-white text-xs px-2 py-1 rounded-md shadow-lg pointer-events-none left-1/2 bottom-full -translate-x-1/2 -translate-y-2 bg-red-900 whitespace-nowrap"
              role="tooltip"
              aria-hidden="true"
            >
              Explicit content
              <span aria-hidden="true" class="absolute left-1/2 top-full w-2 h-2 -translate-x-1/2 -translate-y-1/2 rotate-45 bg-red-900"></span>
            </span>
            <span class="sr-only">Explicit content</span>
          </span>
        {% endif %}
        {% if hasShortRead %}
          <span class="relative inline-flex items-center justify-center uppercase text-xs text-white bg-blue-500 px-2 py-0.5" data-tooltip-trigger tabindex="0" role="button" aria-label="Shorter read" aria-describedby="{{ shortReadTooltipId }}" aria-expanded="false">
            <span aria-hidden="true">S</span>
            <span
              id="{{ shortReadTooltipId }}"
              class="absolute hidden text-white text-xs px-2 py-1 rounded-md shadow-lg pointer-events-none left-1/2 bottom-full -translate-x-1/2 -translate-y-2 bg-blue-900 whitespace-nowrap"
              role="tooltip"
              aria-hidden="true"
            >
              Shorter read 
              <span aria-hidden="true" class="absolute left-1/2 top-full w-2 h-2 -translate-x-1/2 -translate-y-1/2 rotate-45 bg-blue-900"></span>
            </span>
            <span class="sr-only">Shorter read</span>
          </span>
        {% endif %}
      </div>
    {% endif %}
  {%- endset %}
  <div class="book-details xs:w-full">
    <!-- Title -->
    {% if entry.bookCover|length and firstUrl is defined %}
      <div class="flex flex-col md:flex-row md:items-center md:gap-4">
        <h2 class="text-xl font-bold xs:text-base md:text-md lg:text-xl">
          <a href="{{ firstUrl }}" target="_blank" class="inline-block">{{ entry.title }}</a>
        </h2>
        {% if hasBadges %}
          {{ badges|raw }}
        {% endif %}
      </div>
    {% else %}
      <div class="flex flex-col md:flex-row md:items-center md:gap-4">
        <h2 class="text-xl font-bold xs:text-base md:text-md lg:text-xl">
          {{ entry.title }}
        </h2>
        {% if hasBadges %}
          {{ badges|raw }}
        {% endif %}
      </div>
    {% endif %}
    <h3 class="text-xs text-gray-400">{{ entry.authorName }}</h3>

    <!-- Hook -->
    {% if entry.hook %}
      <span class="my-4 text-sm">{{ entry.hook }}</span>
    {% endif %}

    <!-- Store Links -->
    <div class="mb-4">
      {% macro countryFlag(slug) %}
        {% switch slug %}
            {% case "amazon-us" %} ğŸ‡ºğŸ‡¸
            {% case "amazon-au" %} ğŸ‡¦ğŸ‡º
            {% case "amazon-br" %} ğŸ‡§ğŸ‡·
            {% case "amazon-ca" %} ğŸ‡¨ğŸ‡¦
            {% case "amazon-de" %} ğŸ‡©ğŸ‡ª
            {% case "amazon-es" %} ğŸ‡ªğŸ‡¸
            {% case "amazon-fr" %} ğŸ‡«ğŸ‡·
            {% case "amazon-in" %} ğŸ‡®ğŸ‡³
            {% case "amazon-it" %} ğŸ‡®ğŸ‡¹
            {% case "amazon-jp" %} ğŸ‡¯ğŸ‡µ
            {% case "amazon-mx" %} ğŸ‡²ğŸ‡½
            {% case "amazon-nl" %} ğŸ‡³ğŸ‡±
            {% case "amazon-uk" %} ğŸ‡¬ğŸ‡§
            {% default %} ğŸŒ
        {% endswitch %}
      {% endmacro %}

      {% if entry.storeLinks|length %}
        <div class="mb-2 mt-4">
          {% for block in entry.storeLinks %}
              {% set storeCategory = block.stores[0] %}
              {% if storeCategory %}
                  {% set url = block.storeLink %}
                  {% if "amazon" in storeCategory.slug %}
                      {% set url = url ~ aff  %}
                  {% endif %}
                  <a href="{{ url }}" class="xs:text-xs sm:text-sm text-gray-900 uppercase hover:bg-yellow-300 px-2 py-1 inline-block mb-1" target="_blank">
                      {{ _self.countryFlag(storeCategory.slug) }} {{ storeCategory.title }}
                  </a>
              {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Categories (Genre) -->
    <div class="genres">
      {% set genres = entry.genre %}
      {% if genres|length %}
        <div class="text-sm">
          <span class="font-bold xs:text-xs md:text-base">Categories:</span>
          {% for genre in genres %}
            <a href="{{ genre.url }}" class="xs:text-xs md:text-base hover:bg-yellow-300 p-1 mr-1 mb-2">{{ genre.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Tags (Keywords) -->
    <div class="keywords">
      {% set keywords = entry.keywords %}
      {% if keywords|length %}
        <div class="text-sm">
          <span class="font-bold xs:text-xs md:text-base">Keywords:</span>
          {% for keyword in keywords %}
            <a href="{{ url('keywords/' ~ keyword.slug) }}" class="xs:text-xs md:text-base hover:bg-yellow-300 p-1 mr-1 mb-2">{{ keyword.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Categories (Romance Level) -->
    <div class="romance-levels">
      {% set romanceLevels = entry.romanceLevel %}
      {% if romanceLevels|length %}
        <div class="text-sm">
          <span class="font-bold xs:text-xs md:text-base">Romance Level:</span>
          {% for romanceLevel in romanceLevels %}
            <a href="{{ romanceLevel.url }}" class="xs:text-xs md:text-base hover:bg-yellow-300 p-1 mr-1 mb-2">{{ romanceLevel.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Explicit Content -->
    <div class="explicitCat">
      {% set explicitCats = entry.explicitCat %}
      {% if explicitCats|length %}
        <div class="text-sm">
          <span class="font-bold xs:text-xs md:text-base">Explicit Content: </span>
          {% for explicitCat in explicitCats %}
            <a href="{{ explicitCat.url }}" class="xs:text-xs md:text-base hover:bg-yellow-300 p-1 mr-1 mb-2">{{ explicitCat.title }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
