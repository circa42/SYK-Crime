{% set storeCategories = craft.categories.group('store').all() %}
{% set genreCategories = craft.categories.group('genre').all() %}
{% set keywordTags = craft.tags.group('keywords').all() %}

{# Collect related element IDs once so we can render filters without per-button queries #}
{% set bookIds = craft.entries().section('books').ids() %}
{% set availableStoreIds = bookIds ? craft.categories()
    .group('store')
    .relatedTo({
        sourceElement: bookIds,
        field: 'storeLinks'
    })
    .ids()
  : [] %}
{% set availableGenreIds = bookIds ? craft.categories()
    .group('genre')
    .relatedTo({
        sourceElement: bookIds,
        field: 'genre'
    })
    .ids()
  : [] %}
{% set availableKeywordIds = bookIds ? craft.tags()
    .group('keywords')
    .relatedTo({
        sourceElement: bookIds,
        field: 'keywords'
    })
    .ids()
  : [] %}

<form id="filterForm" method="get" action="/search" class="xs:space-y-4 lg:space-y-6">

    <!-- Form -->
    <h2 class="uppercase text-gray-700">Search</h2>  
    <div class="relative flex items-center">
        <label for="searchQuery" class="sr-only">Search books</label>
        <input
            type="text"
            id="searchQuery"
            name="q"
            value="{{ craft.app.request.getQueryParam('q') ?? '' }}"
            placeholder="Search"
            class="w-full sm:w-64 px-4 py-2 pr-10 border border-gray-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300"
        >
    </div>
    
    
    <!-- Store Section -->
    <h2 class="uppercase text-gray-700">Store</h2>
    <div class="flex flex-wrap gap-2">
        {% for category in storeCategories %}
            {% if category.id in availableStoreIds %}
                <button type="button"
                    class="store-button uppercase 
                    xs:px-2 md:px-3 lg:px-4 
                    xs:py-1 md:py-2 lg:py-2 
                    xs:text-xs md:text-base lg:text-lg
                    bg-gray-300 text-gray-800 hover:bg-yellow-300 transition-colors "
                    data-value="{{ category.slug }}">
                    {{ category.title }}
                </button>
            {% endif %}
        {% endfor %}
    </div>   

    <!-- Genre Section -->
    <h2 class="uppercase text-gray-700">Genre</h2>
   <div class="flex flex-wrap gap-2">
        {% for category in genreCategories %}
            {% if category.id in availableGenreIds %}
                <button type="button"
                    class="genre-button uppercase 
                    xs:px-2 md:px-3 lg:px-4 
                    xs:py-1 md:py-2 lg:py-2 
                    xs:text-xs md:text-base lg:text-lg 
                    bg-gray-300 text-gray-800 hover:bg-yellow-300 transition-colors"
                    data-value="{{ category.slug }}">
                    {{ category.title }}
                </button>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Keywords Section -->
    <h2 class="uppercase text-gray-700">Keywords</h2>
    <div class="flex flex-wrap gap-2">
        {% for tag in keywordTags %}
            {% if tag.id in availableKeywordIds %}
                <button type="button"
                    class="keyword-button text-xs uppercase px-2 py-1 bg-gray-300 text-gray-800 hover:bg-yellow-300 transition-colors"
                    data-value="{{ tag.slug }}">
                    {{ tag.title }}
                </button>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Include Explicit Content Section -->
    {% set explicitContent = craft.app.request.getQueryParam('explicit', '0') == '1' %}
    <h2 class="uppercase text-gray-700 mb-2">Explicit Content</h2>
    <div class="flex items-center gap-4 text-sm font-semibold uppercase tracking-wide text-gray-600">
        <span>Show</span>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="explicitSwitch" class="sr-only" {% if explicitContent %} checked {% endif %}>
            <div class="w-11 h-6 bg-gray-300 rounded-full transition-colors duration-300"></div>
            <div class="explicit-switch-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full{% if explicitContent %} is-on{% endif %}"></div>
        </label>
        <span>Hide</span>
    </div>

    <!-- Search Button -->
    {% include "_includes/searchbtn" %}

    <!-- Hidden inputs for the form submission -->
    <input type="hidden" name="store" id="storeInput" value="{{ craft.app.request.getQueryParam('store')|join(',') }}">
    <input type="hidden" name="genre" id="genreInput" value="{{ craft.app.request.getQueryParam('genre')|join(',') }}">
    <input type="hidden" name="keywords" id="keywordsInput" value="{{ craft.app.request.getQueryParam('keywords')|join(',') }}">
    <input type="hidden" name="explicit" id="explicitInput" value="{{ craft.app.request.getQueryParam('explicit', '0') }}">
</form>
